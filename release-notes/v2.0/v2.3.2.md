# Release Notes v2.3.2 - Save Persistence & Runtime Fixes

**Release Date**: 2025-09-18  
**Priority**: High  
**Type**: Bug Fix / Reliability

---

## üö® Critical Issues Resolved

### 1) Session Save Not Persisting in Production
**Problem**: The app reported successful saves, but data did not persist in the database in production.  
**Root Cause**: The save route intentionally bypassed all DB operations when `NODE_ENV === 'production'`, returning success without writes.  
**Resolution**: Removed the production bypass. The route now writes to DB by default and only skips when explicitly disabled via `DB_ENABLED=false`.  
**Files**:  
- `lifecraft-bot/src/app/api/session/save/route.ts`

### 2) Prisma Runtime Mismatch on Edge
**Problem**: API routes using Prisma could run on the Edge runtime, causing failures.  
**Resolution**: Explicitly set Node runtime on Prisma-backed API routes.  
**Files**:
- `lifecraft-bot/src/app/api/session/save/route.ts`  
- `lifecraft-bot/src/app/api/session/[sessionId]/route.ts`  
- `lifecraft-bot/src/app/api/results/[sessionId]/route.ts`

### 3) Overly Strict DB Gate on Results Endpoint
**Problem**: Results endpoint returned 503 unless `DB_ENABLED` was set to `true`, making reads fail by default.  
**Resolution**: The endpoint now assumes DB is enabled unless `DB_ENABLED === 'false'`.  
**Files**:  
- `lifecraft-bot/src/app/api/results/[sessionId]/route.ts`

---

## üîß Technical Changes

- Save route now performs `Session` upsert and writes `Conversation` and `Strength` documents in all environments unless `DB_ENABLED=false` is set.  
- Added `export const runtime = 'nodejs'` to Prisma-using API routes to ensure Node runtime on Render.  
- Relaxed `DB_ENABLED` gate in results endpoint to reduce false negatives during reads.

---

## üöÄ Deployment Checklist

- Render environment variables:
  - `DATABASE_URL` (Render Postgres)
  - `NEXTAUTH_URL`, `NEXTAUTH_SECRET`
  - Optional: `DB_ENABLED=true` (default behavior is enabled unless explicitly `false`)
- Build logs should include:
  - `üìä Using PostgreSQL schema...`
  - `‚úÖ Prisma setup completed successfully!`
- Post-deploy validation:
  - Save a session and expect 200 OK.
  - `GET /api/session/:sessionId` returns stored `messages` and `strengths`.

---

## üß™ Verification Steps

1. Start a new session and progress through conversation.  
2. Trigger save via UI; confirm 200 response.  
3. Fetch `GET /api/session/:sessionId` and verify persisted data.  
4. Check logs for Prisma client queries.

---

## ‚ö†Ô∏è Notes on CI Lint Warnings

- `scripts/setup-prisma.js` uses CommonJS `require()` intentionally for Node execution. If CI flags it, consider:
  - Add the file to ESLint `ignores`, or
  - Migrate to ESM (wider impact as it may require `"type": "module"`).

