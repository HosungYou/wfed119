# Release Notes v2.6.1 - Vision Module English Localization & UX Improvements

**Release Date**: 2025-10-07
**Priority**: High
**Type**: Feature Enhancement / Bug Fix / Localization

---

## 🎯 Overview

This release focuses on internationalizing the Vision Statement module by converting all UI text from Korean to English, implementing development mode authentication for local testing, fixing critical database and deployment issues, and improving user experience with auto-sent AI messages.

---

## ✨ Major Features

### 1) Complete English Localization of Vision Module
**What Changed**: All Korean UI text in the Vision Statement module has been translated to English.
**Impact**: The app is now fully accessible to English-speaking users.
**Commits**:
- `32471d5` - Translate Vision module UI to English and add dev mode authentication

**Files Changed**:
```typescript
// Step Pages (All 4 steps)
src/app/discover/vision/step1/page.tsx
src/app/discover/vision/step2/page.tsx
src/app/discover/vision/step3/page.tsx
src/app/discover/vision/step4/page.tsx

// Components
src/app/discover/vision/components/AIChatBox.tsx
src/app/discover/vision/components/ValuesSummary.tsx

// API Routes
src/app/api/discover/vision/ai-chat/route.ts
src/app/api/discover/vision/check-prerequisites/route.ts
src/app/api/discover/vision/context/route.ts
src/app/api/discover/vision/export-card/route.ts
src/app/api/discover/vision/session/route.ts
src/app/api/discover/vision/templates/route.ts
```

**Translation Coverage**:
- ✅ Alert messages and error dialogs
- ✅ Button labels and placeholders
- ✅ Step titles and descriptions
- ✅ AI system prompts and coaching guidelines
- ✅ Validation criteria and instructions
- ✅ Keyboard shortcuts (e.g., "Shift + Enter for new line, Enter to send")
- ✅ Vision card template names
- ✅ Progress tracking labels

### 2) Development Mode Authentication Bypass
**What Changed**: Added authentication bypass system for local development without requiring Google OAuth login.
**Why**: Enables faster local testing and development iteration without setting up authentication.
**Commits**:
- `32471d5` - Add dev mode authentication

**New File**:
```typescript
// src/lib/dev-auth-helper.ts
export interface AuthResult {
  userId: string;
  isAuthenticated: boolean;
  isDevelopmentMode: boolean;
}

export function checkDevAuth(session: any): AuthResult {
  const isDevelopmentMode = process.env.DEV_MODE_SKIP_AUTH === 'true';

  if (isDevelopmentMode && !session) {
    return {
      userId: 'dev-test-user-id',
      isAuthenticated: true,
      isDevelopmentMode: true
    };
  }

  return {
    userId: session?.user?.id || '',
    isAuthenticated: !!session,
    isDevelopmentMode: false
  };
}

export function requireAuth(auth: AuthResult): boolean {
  return auth.isAuthenticated;
}
```

**Environment Variables**:
```bash
# .env.local
NEXT_PUBLIC_DEV_MODE=true
DEV_MODE_SKIP_AUTH=true
```

**Usage in API Routes**:
```typescript
// Before
const { data: { session }, error: authError } = await supabase.auth.getSession();
if (!session || authError) {
  return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
}
const userId = session.user.id;

// After
const { data: { session } } = await supabase.auth.getSession();
const auth = checkDevAuth(session);
if (!requireAuth(auth)) {
  return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
}
const userId = auth.userId; // 'dev-test-user-id' in dev mode
```

### 3) Auto-Send Initial AI Messages (UX Enhancement)
**What Changed**: AI now automatically sends greeting messages in Steps 2, 3, and 4 without requiring user to type "hello".
**Why**: Improves user onboarding and conversation flow.
**Commits**:
- `7ed494d` - Fix Vision module UX issues and add auto-send initial message

**Implementation** (`src/app/discover/vision/components/AIChatBox.tsx`):
```typescript
const initialMessageSentRef = useRef(false);

useEffect(() => {
  if (initialMessage && messages.length === 0 && !initialMessageSentRef.current) {
    initialMessageSentRef.current = true;

    // Add user's initial message
    const userMessage: Message = {
      role: 'user',
      content: initialMessage,
      timestamp: new Date()
    };

    setMessages([userMessage]);
    setIsStreaming(true);

    // Auto-send to AI
    const sendInitialMessage = async () => {
      const response = await fetch('/api/discover/vision/ai-chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          step,
          userMessage: initialMessage,
          conversationHistory: [],
          context
        })
      });

      // Stream and display AI response...
    };

    sendInitialMessage();
  }
}, [initialMessage, step, context]);
```

**Step 2 Initial Message**:
```typescript
<AIChatBox
  step={2}
  initialMessage="Help me find core aspirations based on my future vision from Step 1."
/>
```

**Result**: Users see immediate AI engagement upon page load.

---

## 🐛 Bug Fixes

### 1) Next.js 15 Async Cookies API Compatibility
**Problem**: `Route "/api/discover/vision/*" used cookies().getAll(). cookies() should be awaited`
**Root Cause**: Next.js 15 changed `cookies()` to an async function.
**Resolution**: Updated `createServerSupabaseClient()` to be async and added `await` to all `cookies()` calls.
**Commits**:
- `32471d5` - Fix Next.js 15 async cookies API compatibility

**Fix** (`src/lib/supabase-server.ts`):
```typescript
// Before
export const createServerSupabaseClient = () => {
  const cookieStore = cookies()

// After
export const createServerSupabaseClient = async () => {
  const cookieStore = await cookies()
```

**All API routes updated**:
```typescript
// Before
const supabase = createServerSupabaseClient();

// After
const supabase = await createServerSupabaseClient();
```

### 2) Database Table Missing (vision_statements)
**Problem**: `PGRST205: Could not find the table 'public.vision_statements' in the schema cache`
**Resolution**: Created migration file for `vision_statements` table with full schema.
**Commits**:
- `1ffe92d` - Add database migration for vision_statements table

**Migration File** (`database/migrations/create-vision-statements.sql`):
```sql
CREATE TABLE IF NOT EXISTS public.vision_statements (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    values_result_id UUID,

    -- Step 1: Imagine Future
    future_imagery TEXT,
    future_imagery_analysis JSONB,

    -- Step 2: Discover Core Aspirations
    core_aspirations JSONB,

    -- Step 3: Draft Vision Statement
    draft_versions JSONB,
    statement_style TEXT,

    -- Step 4: Finalize
    final_statement TEXT,
    selected_template_id TEXT,

    -- Progress tracking
    current_step INTEGER NOT NULL DEFAULT 1,
    is_completed BOOLEAN NOT NULL DEFAULT false,
    completed_at TIMESTAMPTZ,

    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

    CONSTRAINT vision_statements_user_id_unique UNIQUE (user_id),
    CONSTRAINT vision_statements_current_step_check CHECK (current_step >= 1 AND current_step <= 4)
);

-- Indexes
CREATE INDEX IF NOT EXISTS idx_vision_statements_user_id ON public.vision_statements(user_id);
CREATE INDEX IF NOT EXISTS idx_vision_statements_completed ON public.vision_statements(is_completed);

-- RLS Policies
ALTER TABLE public.vision_statements ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own vision statements"
    ON public.vision_statements FOR SELECT
    USING (auth.uid() = user_id);

CREATE POLICY "Users can create their own vision statements"
    ON public.vision_statements FOR INSERT
    WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own vision statements"
    ON public.vision_statements FOR UPDATE
    USING (auth.uid() = user_id)
    WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can delete their own vision statements"
    ON public.vision_statements FOR DELETE
    USING (auth.uid() = user_id);

-- Trigger for updated_at
CREATE OR REPLACE FUNCTION update_vision_statements_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS set_vision_statements_updated_at ON public.vision_statements;
CREATE TRIGGER set_vision_statements_updated_at
    BEFORE UPDATE ON public.vision_statements
    FOR EACH ROW
    EXECUTE FUNCTION update_vision_statements_updated_at();
```

### 3) Render Deployment Root Directory Error
**Problem**: `Service Root Directory "/opt/render/project/src/lifecraft-bot" is missing`
**Root Cause**: Incorrect `rootDir` configuration in `render.yaml`.
**Resolution**: Set `rootDir: .` and updated build command.
**Commits**:
- `1c4056a` - Fix Render deployment: update root directory and build command

**Fix** (`config/render.yaml`):
```yaml
services:
  - type: web
    name: lifecraft-bot
    runtime: node
    plan: starter
    rootDir: .                        # Added
    buildCommand: npm ci && npm run build  # Changed from build:render
    startCommand: npm start
```

### 4) Step 4 Templates API Failure
**Problem**: `Failed to load templates` - `vision_card_templates` table does not exist.
**Resolution**: Return hardcoded default templates instead of querying database.
**Commits**:
- `7ed494d` - Fix Step 4 templates API error

**Fix** (`src/app/api/discover/vision/templates/route.ts`):
```typescript
export async function GET(req: NextRequest) {
  try {
    // Return hardcoded templates (no database required)
    const defaultTemplates = [
      {
        id: 'gradient-purple',
        name: 'Purple Gradient',
        design_config: {
          background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
          textColor: '#ffffff',
          accentColor: '#fbbf24',
          fontFamily: 'inherit'
        }
      },
      {
        id: 'gradient-blue',
        name: 'Ocean Blue',
        design_config: {
          background: 'linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%)',
          textColor: '#ffffff',
          accentColor: '#fbbf24',
          fontFamily: 'inherit'
        }
      },
      {
        id: 'gradient-sunset',
        name: 'Sunset',
        design_config: {
          background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
          textColor: '#ffffff',
          accentColor: '#fbbf24',
          fontFamily: 'inherit'
        }
      },
      {
        id: 'gradient-forest',
        name: 'Forest Green',
        design_config: {
          background: 'linear-gradient(135deg, #0ba360 0%, #3cba92 100%)',
          textColor: '#ffffff',
          accentColor: '#fbbf24',
          fontFamily: 'inherit'
        }
      }
    ];

    return NextResponse.json(defaultTemplates);
  } catch (error) {
    console.error('[Templates] Unexpected error:', error);
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });
  }
}
```

### 5) Chat Box Height Too Large
**Problem**: AI Chat interface in Step 1 was excessively tall, creating poor UX.
**Resolution**: Removed `h-full` and `min-h-[400px]`, set `max-h-[400px]`.
**Commits**:
- `7ed494d` - Reduce AIChatBox height for better layout

**Fix** (`src/app/discover/vision/components/AIChatBox.tsx`):
```typescript
// Before
<div className="flex flex-col h-full bg-white rounded-xl border-2 border-gray-200 shadow-lg">
  <div className="flex-1 overflow-y-auto p-4 space-y-4 min-h-[400px] max-h-[600px]">

// After
<div className="flex flex-col bg-white rounded-xl border-2 border-gray-200 shadow-lg">
  <div className="flex-1 overflow-y-auto p-4 space-y-4 max-h-[400px]">
```

**Result**: Chat box now fits content naturally with reasonable max height.

---

## 🔧 Technical Changes

### Authentication & Session Management
- **Dev Auth Helper**: New utility for development mode authentication bypass
- **Session API**: Updated to use `checkDevAuth()` and support dev user ID
- **Context API**: Updated to return mock user data in dev mode

### Next.js 15 Compatibility
- **Async Cookies**: All `cookies()` calls now properly awaited
- **Supabase Client**: `createServerSupabaseClient()` is now async function
- **Route Handlers**: All API routes updated to await Supabase client creation

### Database Schema
- **vision_statements table**: Comprehensive schema with RLS policies, indexes, and triggers
- **Foreign Keys**: Optional reference to `value_assessment_results` (soft constraint)
- **JSONB Fields**: `core_aspirations`, `draft_versions`, `future_imagery_analysis`

### Deployment Configuration
- **Render Root Directory**: Fixed to use project root (`.`)
- **Build Command**: Simplified to `npm ci && npm run build`
- **Environment Variables**: Added `DEV_MODE_SKIP_AUTH` and `NEXT_PUBLIC_DEV_MODE`

---

## 🚀 Deployment Checklist

### Supabase Setup
1. **Run Migration**: Execute `database/migrations/create-vision-statements.sql` in Supabase SQL Editor
2. **Verify RLS**: Ensure Row Level Security policies are active
3. **Check Indexes**: Confirm indexes on `user_id` and `is_completed` exist

### Render Configuration
1. **Root Directory**: Set to `.` (project root) in dashboard settings
2. **Build Command**: `npm ci && npm run build`
3. **Start Command**: `npm start`
4. **Environment Variables**:
   - `DATABASE_URL` (Supabase connection string)
   - `NEXT_PUBLIC_SUPABASE_URL`
   - `NEXT_PUBLIC_SUPABASE_ANON_KEY`
   - `ANTHROPIC_API_KEY`
   - `OPENAI_API_KEY`
   - Optional: `DEV_MODE_SKIP_AUTH=false` (disable for production)

### Local Development
1. **Environment Setup**:
   ```bash
   # .env.local
   NEXT_PUBLIC_DEV_MODE=true
   DEV_MODE_SKIP_AUTH=true
   NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
   NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
   ANTHROPIC_API_KEY=your_anthropic_key
   OPENAI_API_KEY=your_openai_key
   ```

2. **Start Development Server**:
   ```bash
   npm run dev
   ```

3. **Access Vision Module**:
   - Navigate to `/discover/vision/step1`
   - No login required in dev mode
   - AI messages auto-send on Steps 2-4

---

## 🧪 Verification Steps

### Vision Module Functionality
1. **Step 1: Imagine Future**
   - ✅ Page loads without authentication (dev mode)
   - ✅ Chat interface displays in English
   - ✅ Chat box height is reasonable (not too tall)
   - ✅ AI responds to user input
   - ✅ "Save & Continue" progresses to Step 2

2. **Step 2: Discover Core Aspirations**
   - ✅ AI automatically sends greeting message
   - ✅ Message: "Help me find core aspirations based on my future vision from Step 1."
   - ✅ User can chat with AI without typing "hello"
   - ✅ Core aspirations list updates
   - ✅ Can add 3-5 aspirations manually
   - ✅ "Next Step" progresses to Step 3

3. **Step 3: Draft Vision Statement**
   - ✅ AI auto-generates three vision statement styles
   - ✅ Styles: Action-Oriented, State-Oriented, Inspirational
   - ✅ User can select and edit statements
   - ✅ Draft versions save correctly
   - ✅ "Next Step" progresses to Step 4

4. **Step 4: Finalize & Vision Card**
   - ✅ Templates load successfully (4 gradients)
   - ✅ Vision card preview displays
   - ✅ Template selection works
   - ✅ "Download PNG" exports card
   - ✅ "Complete Vision Statement" marks module as done

### Database Persistence
1. **Create Vision Session**:
   ```bash
   # Check database
   SELECT * FROM vision_statements WHERE user_id = 'dev-test-user-id';
   ```

2. **Verify Data**:
   - ✅ `future_imagery` saved from Step 1
   - ✅ `core_aspirations` JSONB array populated
   - ✅ `draft_versions` JSONB array populated
   - ✅ `final_statement` text saved
   - ✅ `current_step` updates correctly

3. **RLS Validation**:
   - ✅ Users can only access their own data
   - ✅ Anonymous users blocked in production

### Deployment Validation
1. **Render Deployment**:
   - ✅ Build succeeds with `npm run build`
   - ✅ No TypeScript errors
   - ✅ Service starts successfully
   - ✅ Health check passes

2. **Production Access**:
   - ✅ Navigate to `/discover/vision/step1`
   - ✅ Google OAuth login required (dev mode disabled)
   - ✅ Authenticated users can access module
   - ✅ All UI text in English

---

## 📊 Code Statistics

**Files Changed**: 17 files
- **Modified**: 13 files
- **Added**: 4 files
- **Lines Added**: 1,363
- **Lines Removed**: 227

**Commits in This Release**:
1. `32471d5` - Translate Vision module UI to English and add dev mode authentication
2. `1ffe92d` - Add database migration for vision_statements table
3. `1c4056a` - Fix Render deployment: update root directory and build command
4. `7ed494d` - Fix Vision module UX issues and add auto-send initial message

---

## ⚠️ Breaking Changes

### 1) Authentication Required in Production
- **What Changed**: Dev mode authentication only works with `DEV_MODE_SKIP_AUTH=true`
- **Action Required**: Ensure environment variable is set to `false` or removed in production
- **Impact**: Production deployments require proper Supabase authentication

### 2) Next.js 15 API Routes
- **What Changed**: All API routes now use `await createServerSupabaseClient()`
- **Action Required**: None for normal usage; custom API routes must follow new pattern
- **Impact**: Existing custom routes may need updates if they use Supabase

### 3) Database Migration Required
- **What Changed**: New `vision_statements` table must be created
- **Action Required**: Run migration SQL in Supabase dashboard
- **Impact**: Vision module will fail without table

---

## 🔮 Known Issues & Limitations

1. **Value Assessment Integration**:
   - Vision module references `value_assessment_results` table
   - Foreign key constraint removed (table may not exist)
   - Future: Add proper Values Discovery module integration

2. **Template Customization**:
   - Only 4 hardcoded templates available
   - Future: Add `vision_card_templates` table for dynamic templates
   - Admin UI for template management needed

3. **AI Model Deprecation**:
   - Using `claude-3-5-sonnet-20241022` (deprecated)
   - Will reach EOL on October 22, 2025
   - Migration to `claude-3-5-sonnet-20250219` recommended

4. **Export Functionality**:
   - Vision card export uses `html-to-image` library
   - May have rendering issues in some browsers
   - Testing needed across different devices

---

## 📚 Developer Notes

### Working with Vision Module

**Module Structure**:
```
src/app/discover/vision/
├── step1/page.tsx          # Imagine Future
├── step2/page.tsx          # Core Aspirations
├── step3/page.tsx          # Draft Vision
├── step4/page.tsx          # Finalize & Card
├── components/
│   ├── AIChatBox.tsx       # Reusable AI chat component
│   ├── StepProgress.tsx    # Progress indicator
│   └── ValuesSummary.tsx   # Display user values
└── page.tsx                # Module landing page
```

**API Routes**:
```
src/app/api/discover/vision/
├── session/route.ts           # GET/PATCH vision session
├── context/route.ts           # GET user context (values/strengths)
├── ai-chat/route.ts           # POST AI conversation (SSE streaming)
├── check-prerequisites/route.ts  # GET prerequisite validation
├── templates/route.ts         # GET vision card templates
└── export-card/route.ts       # POST export vision card to PNG
```

### Adding New Step Translations

When translating new steps or components:

1. **Page Level**:
   ```typescript
   // Korean
   <h1>비전 문장 작성</h1>

   // English
   <h1>Write Vision Statement</h1>
   ```

2. **Alert Messages**:
   ```typescript
   // Korean
   alert('저장되었습니다.');

   // English
   alert('Saved successfully!');
   ```

3. **AI Prompts**:
   ```typescript
   // Korean
   const prompt = `사용자의 비전을 분석해주세요`;

   // English
   const prompt = `Please analyze the user's vision`;
   ```

4. **Placeholder Text**:
   ```typescript
   // Korean
   placeholder="메시지를 입력하세요..."

   // English
   placeholder="Type your message..."
   ```

### Testing Dev Mode

To test without authentication:

1. Set environment variables:
   ```bash
   NEXT_PUBLIC_DEV_MODE=true
   DEV_MODE_SKIP_AUTH=true
   ```

2. Restart dev server:
   ```bash
   npm run dev
   ```

3. Access any protected route:
   ```
   http://localhost:3000/discover/vision/step1
   ```

4. Check console for dev mode indicator:
   ```
   [Dev Mode] Using dev-test-user-id
   ```

### Debugging Database Issues

If vision_statements queries fail:

1. **Check table exists**:
   ```sql
   SELECT EXISTS (
     SELECT FROM pg_tables
     WHERE schemaname = 'public'
     AND tablename = 'vision_statements'
   );
   ```

2. **Verify RLS policies**:
   ```sql
   SELECT * FROM pg_policies
   WHERE tablename = 'vision_statements';
   ```

3. **Test user access**:
   ```sql
   SET request.jwt.claim.sub = 'user-id-here';
   SELECT * FROM vision_statements;
   ```

4. **Check indexes**:
   ```sql
   SELECT indexname, indexdef
   FROM pg_indexes
   WHERE tablename = 'vision_statements';
   ```

---

## 🙏 Acknowledgments

- **Translation Work**: Complete Korean-to-English localization across 17 files
- **Database Schema**: Comprehensive vision_statements table with RLS
- **UX Improvements**: Auto-send AI messages and optimized chat box height
- **Dev Tooling**: Development mode authentication for faster iteration

---

## 📞 Support

For issues or questions:
- **GitHub Issues**: https://github.com/HosungYou/wfed119/issues
- **Documentation**: See `release-notes/README.md`
- **Migration Guide**: See `database/migrations/create-vision-statements.sql`

---

**🚀 Happy Deploying!**
