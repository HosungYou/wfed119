# Release Notes v2.8.7 - Vision/Enneagram Persistence + Streaming Data Integrity

**Release Date**: 2026-01-05
**Commit**: 1f1c3e7
**Type**: Patch Release + Critical Bug Fixes
**Tier**: Patch Release
**Files Modified**: 43 files

---

## üêõ Critical Deployment Error Fixes

### 1. **Async Supabase Client Used Without Await**
**Error**: `TypeError: supabase.from is not a function`
**Root Cause**: `createServerSupabaseClient()` returns a Promise. Several routes used the Promise directly.
**Fix Mechanism**:
```typescript
// Before (Promise used as client)
const supabase = createServerSupabaseClient();
const { data } = await supabase.from('users').select('*');

// After (awaited client)
const supabase = await createServerSupabaseClient();
const { data } = await supabase.from('users').select('*');
```
**Impact**: Server routes no longer crash when calling `.from()` on a Promise.

### 2. **Admin Stats Blocked by RLS (Permission Denied)**
**Error**: `permission denied for table "users"` on `/api/admin/database/stats`
**Root Cause**: Admin endpoints queried protected tables with anon client under RLS.
**Fix Mechanism**:
```typescript
// Before (anon client under RLS)
const supabase = await createServerSupabaseClient();
const { count } = await supabase.from('users').select('*', { count: 'exact', head: true });

// After (service role for admin-only endpoints)
const admin = createSupabaseAdmin();
const { count } = await admin.from('users').select('*', { count: 'exact', head: true });
```
**Impact**: Admin stats/export endpoints work reliably on Render when `SUPABASE_SERVICE_ROLE_KEY` is configured.

### 3. **SWOT Session Fetch Returning PGRST116**
**Error**: `PGRST116: No rows returned` when `.single()` was used for optional SWOT rows
**Root Cause**: `.single()` throws on empty results, which is valid for first-run sessions.
**Fix Mechanism**:
```typescript
// Before (error on empty result)
const { data } = await supabase
  .from('swot_analyses')
  .select('*')
  .eq('user_id', userId)
  .single();

// After (safe empty result)
const { data } = await supabase
  .from('swot_analyses')
  .select('*')
  .eq('user_id', userId)
  .maybeSingle();
```
**Impact**: First-time SWOT users no longer receive 500 errors during session initialization.

---

## üöÄ Major Features

### 1. **Vision API Alignment With Supabase Tables**
**Implementation**: Vision endpoints now read `value_results` and `strength_profiles` for context and session state.

```typescript
const { data: visionData } = await supabase
  .from('vision_statements')
  .select('*')
  .eq('user_id', userId)
  .maybeSingle();
```

### 2. **Enneagram Persistence + Scoring Pipeline**
**Implementation**: All stages persist to `enneagram_sessions` and compute scores/wing/instinct.

```typescript
const scores = scoreStage1(stage1Responses, locale);
const primary = primaryType(scores.probabilities);
const wingEstimate = `${primary}w${bestWing}`;
```

### 3. **Streaming Chat Persistence**
**Implementation**: `/api/chat/stream` now writes `conversation_messages`, `strength_profiles`, and updates `user_sessions`.

```typescript
await supabase.from('conversation_messages').insert([userMessageData, assistantMessageData]);
await supabase.from('strength_profiles').insert({ session_id, strengths, user_id });
```

### 4. **Admin Database Utilities**
**Implementation**: Added export and cleanup endpoints with service-role guards for admin workflows.

### 5. **Supabase Login Entry Point**
**Implementation**: Added `/login` page for OAuth-based Supabase sign-in.

---

## üõ†Ô∏è Technical Implementation Details

### Values Results: Supabase Auth + Metadata
**Change**: Results now require Supabase session and store `insights` + `module_version`.

```typescript
const { data: { session } } = await supabase.auth.getSession();
if (!session?.user) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });

await supabase.from('value_results').upsert({
  user_id: session.user.id,
  value_set: valueSet,
  layout,
  top3: top3Array,
  insights: insights || null,
  module_version: moduleVersion,
});
```

### Vision Context Normalization
**Change**: Normalize Top 3 values and strengths from `strength_profiles` with `user_email` fallback.

---

## üìä Data Structure Changes

### New Table: `enneagram_sessions`
**Migration File** (`database/migrations/2025-11-25-create-enneagram-sessions.sql`):
```sql
CREATE TABLE IF NOT EXISTS public.enneagram_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id TEXT NOT NULL UNIQUE,
  user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  locale TEXT NOT NULL DEFAULT 'en',
  stage TEXT NOT NULL DEFAULT 'screener',
  responses JSONB NOT NULL DEFAULT '{}'::jsonb,
  scores JSONB,
  primary_type TEXT,
  wing_estimate TEXT,
  instinct TEXT,
  confidence TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

---

## üîß Deployment Verification

- `GET /api/health` ‚Üí returns `status: healthy` or `degraded` with Supabase details
- `GET /api/discover/vision/session` ‚Üí creates/loads `vision_statements` for the user
- `POST /api/enneagram/answer` ‚Üí persists stage responses to `enneagram_sessions`
- `POST /api/enneagram/score` ‚Üí returns `primaryType`, `wingEstimate`, `instinct`
- `POST /api/chat/stream` ‚Üí inserts `conversation_messages` + `strength_profiles`
- `GET /api/admin/database/stats` ‚Üí requires `SUPABASE_SERVICE_ROLE_KEY` + SUPER_ADMIN
- `GET /login` ‚Üí Supabase OAuth login flow

---

## üìã Technical Summary

**Files Modified**: 43 files
- `.mcp.json` - Supabase MCP server configuration
- `config/.env.example` - Environment variable template updates
- `config/.env.shared` - Supabase env guidance for shared config
- `config/next.config.js` - Output tracing root for Render
- `database/migrations/2025-11-25-create-enneagram-sessions.sql` - Enneagram session table + RLS policies
- `release-notes/README.md` - Release index updated to v2.8.7
- `release-notes/v2.0/v2.8.7.md` - Release documentation
- `scripts/setup-env-from-secrets.js` - Supabase env hydration
- `src/app/api/admin/check-access/route.ts` - Supabase session-based admin check
- `src/app/api/admin/database/cleanup/route.ts` - Admin cleanup endpoint
- `src/app/api/admin/database/export/route.ts` - Admin export endpoint (JSON/CSV)
- `src/app/api/admin/database/stats/route.ts` - Service-role stats + strengths aggregation
- `src/app/api/admin/share/route.ts` - Supabase auth gating for admin sharing
- `src/app/api/chat/route.ts` - Supabase session-backed chat metadata
- `src/app/api/chat/stream/route.ts` - Streaming persistence for messages + strengths
- `src/app/api/conversations/[sessionId]/route.ts` - Supabase conversation lookup fixes
- `src/app/api/conversations/route.ts` - Supabase conversation list fixes
- `src/app/api/dashboard/user-data/route.ts` - Strengths data fetch from Supabase
- `src/app/api/discover/strengths/results/route.ts` - Strengths results endpoint
- `src/app/api/discover/values/results/all/route.ts` - Supabase auth gating for values export
- `src/app/api/discover/values/results/layout-utils.ts` - Supabase layout normalization
- `src/app/api/discover/values/results/route.ts` - Supabase auth + metadata storage
- `src/app/api/discover/vision/ai-chat/route.ts` - Vision AI chat aligned with Supabase tables
- `src/app/api/discover/vision/check-prerequisites/route.ts` - Vision prerequisites check
- `src/app/api/discover/vision/context/route.ts` - Vision context assembly from Supabase
- `src/app/api/discover/vision/export-card/route.ts` - Vision export rendering
- `src/app/api/discover/vision/session/route.ts` - Vision session create/update
- `src/app/api/discover/vision/templates/route.ts` - Vision template listing
- `src/app/api/discover/vision/validate/route.ts` - Vision validation logic
- `src/app/api/enneagram/answer/route.ts` - Persist Enneagram stage responses
- `src/app/api/enneagram/export/route.ts` - Export Enneagram profile
- `src/app/api/enneagram/items/route.ts` - Discriminator item selection by score
- `src/app/api/enneagram/score/route.ts` - Score + persist Enneagram profile
- `src/app/api/health/route.ts` - Supabase health check with timeout
- `src/app/api/results/[sessionId]/route.ts` - Unified results for strengths + enneagram
- `src/app/api/session/[sessionId]/route.ts` - Supabase session retrieval fixes
- `src/app/api/session/save/route.ts` - Supabase session save fixes
- `src/app/api/swot/errc/route.ts` - Safe `.maybeSingle()` usage
- `src/app/api/swot/goals/route.ts` - SWOT goals validation updates
- `src/app/api/swot/session/route.ts` - SWOT session fetch fixes
- `src/app/discover/swot/strategy/page.tsx` - Prioritization stage transition
- `src/app/login/page.tsx` - Supabase login page
- `src/lib/supabase.ts` - Service role client + nullable session typing

**Algorithmic Achievement**: End-to-end Enneagram scoring pipeline with persistent stage responses and deterministic discriminator selection.
**Next Release**: v2.8.8 - Enneagram UX polish + dashboard progress wiring
