# Release Notes v2.8.7 - Supabase Auth Unification, Vision API Promotion, Enneagram Persistence

**Release Date**: 2026-01-05
**Commit**: 669e386
**Type**: Patch Release + Critical Bug Fixes
**Tier**: Patch Release
**Files Modified**: 74 files

---

## üêõ Critical Deployment Error Fixes

### 1. **Async Supabase Client Used Without Await**
**Error**: `TypeError: supabase.from is not a function`
**Root Cause**: `createServerSupabaseClient()` returns a Promise. Several routes used the Promise directly.
**Fix Mechanism**:
```typescript
// Before (Promise used as client)
const supabase = createServerSupabaseClient();
const { data } = await supabase.from('users').select('*');

// After (awaited client)
const supabase = await createServerSupabaseClient();
const { data } = await supabase.from('users').select('*');
```
**Impact**: Server routes no longer crash when calling `.from()` on a Promise.

### 2. **Admin Stats Blocked by RLS (Permission Denied)**
**Error**: `permission denied for table "users"` on `/api/admin/database/stats`
**Root Cause**: Admin endpoints queried protected tables with anon client under RLS.
**Fix Mechanism**:
```typescript
// Before (anon client under RLS)
const supabase = await createServerSupabaseClient();
const { count } = await supabase.from('users').select('*', { count: 'exact', head: true });

// After (service role for admin-only endpoints)
const admin = createSupabaseAdmin();
const { count } = await admin.from('users').select('*', { count: 'exact', head: true });
```
**Impact**: Admin stats/export endpoints work reliably on Render when `SUPABASE_SERVICE_ROLE_KEY` is configured.

### 3. **SWOT Session Fetch Returning PGRST116**
**Error**: `PGRST116: No rows returned` when `.single()` was used for optional SWOT rows
**Root Cause**: `.single()` throws on empty results, which is valid for first-run sessions.
**Fix Mechanism**:
```typescript
// Before (error on empty result)
const { data } = await supabase
  .from('swot_analyses')
  .select('*')
  .eq('user_id', userId)
  .single();

// After (safe empty result)
const { data } = await supabase
  .from('swot_analyses')
  .select('*')
  .eq('user_id', userId)
  .maybeSingle();
```
**Impact**: First-time SWOT users no longer receive 500 errors during session initialization.

---

## üöÄ Major Features

### 1. **Supabase Auth Unification + /login Page**
**Implementation**: Removed NextAuth wiring and standardized all auth flows on Supabase OAuth.
**UI Change**: Added `/login` and replaced NextAuth providers with Supabase session checks.

```typescript
// Supabase OAuth sign-in (new)
await supabase.auth.signInWithOAuth({
  provider: 'google',
  options: { redirectTo: `${window.location.origin}/auth/callback` }
});
```

### 2. **Discover Vision API Promotion (discover 2 ‚Üí discover)**
**Implementation**: Promoted Vision endpoints to `/api/discover/vision/*` and aligned with real tables:
`vision_statements`, `value_results`, `strength_profiles`, `conversation_messages`, `user_sessions`.

```typescript
const { data: visionData } = await supabase
  .from('vision_statements')
  .select('*')
  .eq('user_id', userId)
  .maybeSingle();
```

### 3. **Enneagram Persistence + Scoring Pipeline**
**Implementation**: All stages persist to `enneagram_sessions` and compute scores/wing/instinct.

```typescript
const scores = scoreStage1(stage1Responses, locale);
const primary = primaryType(scores.probabilities);
const wingEstimate = `${primary}w${bestWing}`;
```

### 4. **Streaming Chat Persistence**
**Implementation**: `/api/chat/stream` now writes `conversation_messages`, `strength_profiles`, and updates `user_sessions`.

```typescript
await supabase.from('conversation_messages').insert([userMessageData, assistantMessageData]);
await supabase.from('strength_profiles').insert({ session_id, strengths, user_id });
```

### 5. **SWOT Prioritization + Reflection Generation**
**Implementation**: Added prioritization UI stage, reflection generation endpoints, and API support for strategy scoring.

---

## üõ†Ô∏è Technical Implementation Details

### Values Results: Supabase Auth + Metadata
**Change**: Results now require Supabase session and store `insights` + `module_version`.

```typescript
const { data: { session } } = await supabase.auth.getSession();
if (!session?.user) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });

await supabase.from('value_results').upsert({
  user_id: session.user.id,
  value_set: valueSet,
  layout,
  top3: top3Array,
  insights: insights || null,
  module_version: moduleVersion,
});
```

### Vision Draft Storage
**Change**: Brainstormed options + selected option index are stored under `draft_versions`.

```typescript
const draftPayload = { ...draft_versions } as Record<string, unknown>;
if (brainstormed_options !== undefined) draftPayload.brainstormed_options = brainstormed_options;
if (selected_option_index !== undefined) draftPayload.selected_option_index = selected_option_index;
```

### Admin Export Pagination
**Change**: Export endpoint fetches data in 1,000-row pages and supports JSON/CSV.

---

## üìä Data Structure Changes

### New Table: `enneagram_sessions`
**Migration File** (`database/migrations/2025-11-25-create-enneagram-sessions.sql`):
```sql
CREATE TABLE IF NOT EXISTS public.enneagram_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id TEXT NOT NULL UNIQUE,
  user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  locale TEXT NOT NULL DEFAULT 'en',
  stage TEXT NOT NULL DEFAULT 'screener',
  responses JSONB NOT NULL DEFAULT '{}'::jsonb,
  scores JSONB,
  primary_type TEXT,
  wing_estimate TEXT,
  instinct TEXT,
  confidence TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

### SWOT Stage + Reflection Fields
**Migration File** (`database/migrations/2025-10-23-update-swot-strategy-priorities.sql`):
```sql
ALTER TABLE public.swot_analyses ADD CONSTRAINT swot_analyses_current_stage_check CHECK (
  current_stage IN ('analysis', 'strategy', 'prioritization', 'reflection', 'completed')
);

ALTER TABLE public.swot_analyses
ADD COLUMN IF NOT EXISTS reflection_questions JSONB DEFAULT '[]'::jsonb;

CREATE OR REPLACE VIEW swot_strategy_priorities_view AS
SELECT
  sa.id AS swot_id,
  jsonb_array_elements(sa.strategy_priorities) AS strategy
FROM public.swot_analyses sa;
```

---

## üîß Deployment Verification

- `GET /api/health` ‚Üí returns `status: healthy` or `degraded` with Supabase details
- `GET /api/discover/vision/session` ‚Üí creates/loads `vision_statements` for the user
- `POST /api/enneagram/answer` ‚Üí persists stage responses to `enneagram_sessions`
- `POST /api/enneagram/score` ‚Üí returns `primaryType`, `wingEstimate`, `instinct`
- `POST /api/chat/stream` ‚Üí inserts `conversation_messages` + `strength_profiles`
- `GET /api/admin/database/stats` ‚Üí requires `SUPABASE_SERVICE_ROLE_KEY` + SUPER_ADMIN
- `GET /login` ‚Üí Supabase OAuth login flow

---

## üìã Technical Summary

**Files Modified**: 74 files
- `.mcp.json` - Supabase MCP server configuration
- `config/.env.example` - Environment variable template updates
- `config/.env.shared` - Supabase env guidance for shared config
- `config/next.config.js` - Render tracing root configuration
- `database/migrations/2025-10-23-update-swot-strategy-priorities.sql` - SWOT prioritization schema updates
- `database/migrations/2025-11-25-create-enneagram-sessions.sql` - Enneagram session table + RLS policies
- `package-lock.json` - Dependency lockfile updates
- `package.json` - Dependency metadata updates
- `release-notes/README.md` - Release index updated to v2.8.7
- `release-notes/v2.0/v2.8.7.md` - Release documentation
- `scripts/setup-env-from-secrets.js` - Supabase env hydration
- `src/app/api/admin/check-access/route.ts` - Supabase session-based admin check
- `src/app/api/admin/database/cleanup/route.ts` - Admin cleanup stub with service role guard
- `src/app/api/admin/database/export/route.ts` - Admin export endpoint (JSON/CSV)
- `src/app/api/admin/database/stats/route.ts` - Service-role stats + strengths aggregation
- `src/app/api/admin/share/route.ts` - Supabase auth gating for admin sharing
- `src/app/api/auth/[...nextauth]/route.ts` - Removed legacy NextAuth handler
- `src/app/api/chat/route.ts` - Supabase session-backed chat metadata
- `src/app/api/chat/stream/route.ts` - Streaming persistence for messages + strengths
- `src/app/api/conversations 2/[sessionId]/route.ts` - Legacy conversations route updates
- `src/app/api/conversations 2/route.ts` - Legacy conversations route updates
- `src/app/api/conversations/[sessionId]/route.ts` - Supabase conversation lookup fixes
- `src/app/api/conversations/route.ts` - Supabase conversation list fixes
- `src/app/api/dashboard/user-data/route.ts` - Strengths data fetch from Supabase
- `src/app/api/discover 2/values/results/README.txt` - Removed legacy Discover 2 docs
- `src/app/api/discover 2/values/results/all/route.ts` - Removed legacy Discover 2 values API
- `src/app/api/discover 2/values/results/layout-utils.ts` - Removed legacy Discover 2 layout utils
- `src/app/api/discover 2/values/results/route.ts` - Removed legacy Discover 2 values API
- `src/app/api/discover 2/vision/ai-chat/route.ts` - Removed legacy Discover 2 vision AI chat
- `src/app/api/discover 2/vision/check-prerequisites/route.ts` - Removed legacy Discover 2 vision prereq
- `src/app/api/discover 2/vision/context/route.ts` - Removed legacy Discover 2 vision context
- `src/app/api/discover 2/vision/export-card/route.ts` - Removed legacy Discover 2 export
- `src/app/api/discover 2/vision/session/route.ts` - Removed legacy Discover 2 vision session
- `src/app/api/discover 2/vision/templates/route.ts` - Removed legacy Discover 2 templates
- `src/app/api/discover 2/vision/validate/route.ts` - Removed legacy Discover 2 validation
- `src/app/api/discover/strengths/results/route.ts` - Strengths results endpoint
- `src/app/api/discover/values/results/all/route.ts` - Supabase auth gating for values export
- `src/app/api/discover/values/results/layout-utils.ts` - Supabase layout normalization
- `src/app/api/discover/values/results/route.ts` - Supabase auth + metadata storage
- `src/app/api/discover/vision/ai-chat/route.ts` - Vision AI chat aligned with Supabase tables
- `src/app/api/discover/vision/check-prerequisites/route.ts` - Vision prerequisites check
- `src/app/api/discover/vision/context/route.ts` - Vision context assembly from Supabase
- `src/app/api/discover/vision/export-card/route.ts` - Vision export rendering
- `src/app/api/discover/vision/session/route.ts` - Vision session create/update
- `src/app/api/discover/vision/templates/route.ts` - Vision template listing
- `src/app/api/discover/vision/validate/route.ts` - Vision validation logic
- `src/app/api/enneagram/answer/route.ts` - Persist Enneagram stage responses
- `src/app/api/enneagram/export/route.ts` - Export Enneagram profile
- `src/app/api/enneagram/items/route.ts` - Discriminator item selection by score
- `src/app/api/enneagram/score/route.ts` - Score + persist Enneagram profile
- `src/app/api/health/route.ts` - Supabase health check with timeout
- `src/app/api/results/[sessionId]/route.ts` - Unified results for strengths + enneagram
- `src/app/api/session/[sessionId]/route.ts` - Supabase session retrieval fixes
- `src/app/api/session/save/route.ts` - Supabase session save fixes
- `src/app/api/swot/errc/route.ts` - Safe `.maybeSingle()` usage
- `src/app/api/swot/generate-reflection-draft/route.ts` - Reflection draft generation
- `src/app/api/swot/generate-reflection-questions/route.ts` - Reflection question generation
- `src/app/api/swot/generate-strategies/route.ts` - Strategy generation endpoint
- `src/app/api/swot/goals/route.ts` - SWOT goals validation updates
- `src/app/api/swot/session/route.ts` - SWOT session fetch fixes
- `src/app/dashboard/page.tsx` - Dashboard data from Supabase tables
- `src/app/discover/swot/analysis/page.tsx` - SWOT flow alignment
- `src/app/discover/swot/components/StepProgress.tsx` - SWOT step progress UI
- `src/app/discover/swot/prioritization/page.tsx` - Strategy prioritization UI
- `src/app/discover/swot/reflection/page.tsx` - Reflection UI updates
- `src/app/discover/swot/strategy/page.tsx` - Strategy UI updates
- `src/app/discover/values/[set]/page.tsx` - Supabase-authenticated value sorting flow
- `src/app/discover/values/page.tsx` - Supabase login controls for values landing
- `src/app/login/page.tsx` - New Supabase login page
- `src/components/HomePage.tsx` - Homepage route updates
- `src/components/Providers.tsx` - Removed NextAuth provider wrapper
- `src/lib/supabase.ts` - Service role client + nullable session typing
- `src/types 2/next-auth.d.ts` - Removed legacy NextAuth types
- `src/types/next-auth.d.ts` - Removed legacy NextAuth types

**Algorithmic Achievement**: Unified Supabase auth across modules while persisting Enneagram scoring and streaming chat data into durable session tables.
**Next Release**: v2.8.8 - Enneagram UX polish + dashboard progress wiring
