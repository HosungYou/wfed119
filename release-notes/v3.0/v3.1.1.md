# Release Notes - v3.1.1

**Release Date**: 2026-01-06
**Type**: Patch Release - Consent System + Bug Fixes
**Commit**: `1d43a39`

---

## Summary

Critical fixes for user authentication flow and module display:
- User consent system for privacy policy and research participation
- Translation fixes (8 â†’ 10 modules display)
- RLS policies for `public.users` table enabling admin checks
- GitHub webhook configuration for Render auto-deploy

---

## ðŸ› Critical Bug Fixes

### 1. Admin Module Lock Not Working

**Error**:
```
[ModuleProgressService] Could not fetch user role: {
  code: 'PGRST116',
  details: 'The result contains 0 rows',
  message: 'Cannot coerce the result to a single JSON object'
}
```

**Root Cause**: RLS (Row Level Security) was enabled on `public.users` table but no policies were defined, causing all queries to return 0 rows.

**Fix Mechanism**:
```sql
-- Added 4 RLS policies to public.users table
CREATE POLICY "Users can read own row" ON public.users
  FOR SELECT USING (auth.uid() = id);

CREATE POLICY "Users can update own row" ON public.users
  FOR UPDATE USING (auth.uid() = id);

CREATE POLICY "Service role can read all" ON public.users
  FOR SELECT TO service_role USING (true);

CREATE POLICY "Authenticated users can insert own row" ON public.users
  FOR INSERT TO authenticated WITH CHECK (auth.uid() = id);
```

**Impact**: Admin users can now bypass module locks as intended.

### 2. Module Count Display Error

**Error**: Homepage and Dashboard showing "8 modules" instead of "10 modules"

**Root Cause**: Translation files (`en.json`, `ko.json`) not updated after adding mission and career-options modules.

**Fix Mechanism**:
```json
// Before
"description": "...through 8 modules..."
"subtitle": "Complete 8 modules in sequence"
"outOf": "/ 8 total"

// After
"description": "...through 10 modules..."
"subtitle": "Complete 10 modules in sequence"
"outOf": "/ 10 total"
```

**Files Modified**:
- `src/lib/i18n/translations/en.json`
- `src/lib/i18n/translations/ko.json`

**Impact**: Correct module count displayed across all UI components.

---

## New Features

### User Consent System

Integrated consent flow for privacy policy and research participation agreement.

**Components**:
| File | Purpose |
|------|---------|
| `ConsentModal.tsx` | Modal UI with bilingual (EN/KO) consent form |
| `ConsentGuard.tsx` | Wrapper that auto-shows modal for users without consent |
| `/api/auth/consent/route.ts` | GET/POST API for consent management |

**Database Schema**:
```sql
CREATE TABLE public.user_consent_agreements (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  privacy_policy_agreed BOOLEAN NOT NULL DEFAULT false,
  research_consent_agreed BOOLEAN DEFAULT false,
  consent_data_collection BOOLEAN DEFAULT false,
  consent_ai_processing BOOLEAN DEFAULT false,
  ip_address TEXT,
  user_agent TEXT,
  consent_version VARCHAR(20) DEFAULT '1.0',
  agreed_at TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id)
);
```

**Flow**:
1. User signs in via Google OAuth
2. `ConsentGuard` checks consent status via `/api/auth/consent`
3. If no consent, `ConsentModal` displays (cannot be closed)
4. User agrees to privacy policy (required) and research participation (optional)
5. Consent recorded in database, user proceeds to app

**UI Features**:
- Privacy policy agreement (required)
- Research participation consent (optional)
- Penn State University research attribution
- Korean/English bilingual support
- Non-dismissible modal until consent given

### User Table Auto-Sync

Migrated 45 existing users from `auth.users` to `public.users` table.

```sql
INSERT INTO public.users (id, email, full_name, avatar_url, role, created_at, updated_at)
SELECT
  id, email, raw_user_meta_data->>'full_name',
  raw_user_meta_data->>'avatar_url', 'USER', created_at, NOW()
FROM auth.users
WHERE id NOT IN (SELECT id FROM public.users);
```

**Result**: 45 users synced with `role = 'USER'` and `consent_agreed = false`

---

## Infrastructure

### GitHub Webhook for Render Auto-Deploy

**Issue**: All Render deploys showing `trigger: "manual"` despite `autoDeploy: "yes"`

**Solution**: Created GitHub webhook pointing to Render Deploy Hook URL

**Configuration**:
- Payload URL: Render Deploy Hook URL
- Content type: `application/json`
- Events: Push events only
- SSL verification: Enabled

---

## Database Migrations

| Migration | Description |
|-----------|-------------|
| `add_users_rls_policies` | 4 RLS policies for public.users |
| `create_user_consent_agreements` | Consent tracking table |
| User sync migration | 45 users from auth.users |

---

## Files Modified

**New Files (4)**:
- `src/components/auth/ConsentModal.tsx`
- `src/components/auth/ConsentGuard.tsx`
- `src/app/api/auth/consent/route.ts`
- `release-notes/v3.0/v3.1.1.md`

**Modified Files (4)**:
- `src/lib/i18n/translations/en.json` - 10 modules, mission/career translations
- `src/lib/i18n/translations/ko.json` - 10 modules, mission/career translations
- `src/contexts/AuthContext.tsx` - Consent state management
- `src/components/Providers.tsx` - ConsentGuard wrapper

---

## Upgrade Notes

### From v3.1.0 to v3.1.1

No code changes required. Database migrations applied automatically.

**Verify RLS policies**:
```sql
SELECT policyname FROM pg_policies WHERE tablename = 'users';
-- Should return 4 policies
```

**Check consent table**:
```sql
SELECT COUNT(*) FROM public.user_consent_agreements;
```

---

## Known Issues

- First-time users will see consent modal immediately after OAuth
- Existing users must agree to consent on next login

---

**GitHub Release**: [v3.1.1](https://github.com/HosungYou/wfed119/releases/tag/v3.1.1)
