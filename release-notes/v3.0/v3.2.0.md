# Release Notes - v3.2.0

**Release Date**: 2026-01-07
**Type**: Major Patch - Claude Model Migration + Session Reset System
**Commit**: TBD

---

## Summary

Critical infrastructure update addressing Claude API model retirement and implementing user experience improvements:
- **Claude 3.5 Sonnet retired on January 5, 2026** - All 11 AI endpoints migrated to `claude-sonnet-4-20250514`
- New `SessionResetButton` component for restarting module progress
- Values module session endpoint with GET/DELETE operations
- Cross-module AI context system foundation

---

## üêõ Critical Bug Fixes

### 1. Claude 3.5 Sonnet Model Retired (404 Error)

**Error**:
```
404 {"type":"error","error":{"type":"not_found_error","message":"model: claude-3-5-sonnet-20241022..."}}
```

**Root Cause**: Anthropic retired the Claude 3.5 Sonnet model (`claude-3-5-sonnet-20241022`) on **January 5, 2026**. All API calls using this model now return 404 errors.

**Fix Mechanism**:
```typescript
// Before (deprecated - retired Jan 5, 2026)
model: 'claude-3-5-sonnet-20241022'

// After (current production model)
model: 'claude-sonnet-4-20250514'
```

**Files Modified (11 endpoints)**:
| File | Function |
|------|----------|
| `src/app/api/discover/mission/ai-suggest/route.ts` | Mission statement AI suggestions |
| `src/app/api/discover/vision/ai-chat/route.ts` | Vision AI chat interface |
| `src/app/api/discover/vision/validate/route.ts` | Vision statement validation |
| `src/app/api/discover/career-options/ai-suggest/route.ts` | Career option suggestions |
| `src/app/api/swot/auto-fill/route.ts` | SWOT auto-population |
| `src/app/api/swot/generate-strategies/route.ts` | SWOT strategy generation |
| `src/app/api/swot/generate-reflection-questions/route.ts` | Reflection questions |
| `src/app/api/swot/generate-reflection-draft/route.ts` | Reflection draft generation |
| `src/app/api/dreams/analyze/route.ts` | Dreams analysis |
| `src/app/api/dreams/finalize/route.ts` | Dreams finalization |
| `src/app/api/dreams/generate-suggestions/route.ts` | Dreams suggestions |

**Impact**: All AI-powered features now functional with Claude Sonnet 4 model.

### 2. Values Session Endpoint Missing (404 Error)

**Error**:
```
GET /api/discover/values/session - 404 Not Found
```

**Root Cause**: Session endpoint for Values module was not created, preventing session status checks.

**Fix Mechanism**:
Created new endpoint `src/app/api/discover/values/session/route.ts`:

```typescript
// GET - Returns completion status for all three value types
export async function GET(req: NextRequest) {
  const { data: valueResults } = await supabase
    .from('value_results')
    .select('value_set, top3, layout, updated_at')
    .eq('user_id', userId);

  return NextResponse.json({
    terminal_values: [...],
    terminal_completed: boolean,
    instrumental_values: [...],
    instrumental_completed: boolean,
    work_values: [...],
    work_completed: boolean
  });
}

// DELETE - Resets all value results for user
export async function DELETE(req: NextRequest) {
  await supabase.from('value_results').delete().eq('user_id', userId);
  await supabase.from('module_progress').delete()
    .eq('user_id', userId).eq('module_id', 'values');
  return NextResponse.json({ success: true });
}
```

**Impact**: Values module can now check session status and reset progress.

### 3. Mission AI Suggest Body Variable Scope Error

**Error**:
```
ReferenceError: body is not defined
```

**Root Cause**: Variable `body` declared inside try block but used in catch fallback.

**Fix Mechanism**:
```typescript
// Before (error)
export async function POST(req: NextRequest) {
  try {
    const body = await req.json();
    // ... AI call
  } catch (error) {
    // Error: body not accessible here
    return generateFallback(body.context);
  }
}

// After (fixed)
export async function POST(req: NextRequest) {
  let body: any;
  try {
    body = await req.json();
    // ... AI call
  } catch (error) {
    // body now accessible
    return generateFallback(body?.context);
  }
}
```

**Impact**: Mission AI suggest endpoint no longer crashes on AI failures.

---

## üöÄ New Features

### 1. Session Reset Button Component

**Path**: `src/components/modules/SessionResetButton.tsx`

Reusable component for resetting module progress with confirmation dialog.

**Implementation**:
```typescript
interface SessionResetButtonProps {
  moduleId: string;
  moduleName: { ko: string; en: string };
  onReset?: () => void;
  apiEndpoint?: string;
  className?: string;
}

export function SessionResetButton({
  moduleId, moduleName, onReset, apiEndpoint, className
}: SessionResetButtonProps) {
  // Two-stage UI:
  // 1. Initial button: "ÏÉàÎ°ú ÏãúÏûëÌïòÍ∏∞" / "Start Fresh"
  // 2. Confirmation panel with warning and confirm/cancel
}
```

**Features**:
- Bilingual support (Korean/English)
- Confirmation dialog with warning message
- Loading state with spinner
- Error message display
- Customizable API endpoint
- Optional callback on reset

**UI States**:
| State | Display |
|-------|---------|
| Initial | Button with RotateCcw icon |
| Confirming | Amber warning panel with AlertTriangle |
| Loading | Spinner with "Ï¥àÍ∏∞Ìôî Ï§ë..." / "Resetting..." |
| Error | Red error message |

### 2. Module Components Export

**Path**: `src/components/modules/index.ts`

Added SessionResetButton to module component exports:
```typescript
export { SessionResetButton } from './SessionResetButton';
```

---

## üõ†Ô∏è Technical Implementation Details

### Claude Model Migration

Migration command used:
```bash
sed -i '' 's/claude-3-5-sonnet-20241022/claude-sonnet-4-20250514/g' \
  src/app/api/discover/mission/ai-suggest/route.ts \
  src/app/api/discover/vision/ai-chat/route.ts \
  # ... (11 files total)
```

### Session Reset Architecture

**Flow**:
1. User clicks "Start Fresh" button
2. Confirmation dialog shows with warning
3. User confirms ‚Üí DELETE request to `/api/discover/{module}/session`
4. Backend deletes from:
   - Module-specific table (e.g., `value_results`)
   - `module_progress` table
5. On success: Page reloads or custom callback executes

### Module Reset Status

| Module | Reset Method | API Endpoint |
|--------|--------------|--------------|
| Values | SessionResetButton | `/api/discover/values/session` |
| Strengths | ChatInterface reset | Built-in |
| Enneagram | URL session param | Query string |
| Life Themes | Built-in handleRestart | `/api/life-themes/session` |
| Vision | Built-in handleRestart | `/api/discover/vision/session` |
| Mission | Built-in handleRestart | `/api/discover/mission/session` |
| Career Options | Built-in handleRestart | `/api/discover/career-options/session` |
| SWOT | Built-in handleRestart | `/api/swot/session` |
| Goals | Built-in handleRestart | `/api/goals/session` |
| ERRC | Built-in handleRestart | `/api/errc/session` |

---

## üìä Documentation Updates

### Plan Documents Created

| File | Purpose |
|------|---------|
| `docs/plans/2026-01-06_rebase-plan-v3.1.md` | v3.1 implementation plan |
| `docs/plans/2026-01-07_rebase-plan-v3.2.md` | v3.2 implementation plan with AI context system |

### v3.2 Plan Highlights

1. **Critical Bug Fixes** (Completed)
   - 500 error fixes
   - Start button fix
   - Context route updates

2. **Cross-Module AI Context System** (Planned)
   - AIContextService for building context prompts
   - ModuleProgressService extensions
   - Module-specific AI prompts

3. **Frontend Enhancements** (Planned)
   - AIContextCard component
   - AISuggestionPanel component

---

## üìã Files Modified

**New Files (4)**:
- `src/app/api/discover/values/session/route.ts` - Values session GET/DELETE API
- `src/components/modules/SessionResetButton.tsx` - Reusable reset button component
- `docs/plans/2026-01-06_rebase-plan-v3.1.md` - v3.1 plan documentation
- `docs/plans/2026-01-07_rebase-plan-v3.2.md` - v3.2 plan documentation

**Modified Files (12)**:
- `src/components/modules/index.ts` - Added SessionResetButton export
- `src/app/api/discover/mission/ai-suggest/route.ts` - Model + body scope fix
- `src/app/api/discover/vision/ai-chat/route.ts` - Model update
- `src/app/api/discover/vision/validate/route.ts` - Model update
- `src/app/api/discover/career-options/ai-suggest/route.ts` - Model update
- `src/app/api/swot/auto-fill/route.ts` - Model update
- `src/app/api/swot/generate-strategies/route.ts` - Model update
- `src/app/api/swot/generate-reflection-questions/route.ts` - Model update
- `src/app/api/swot/generate-reflection-draft/route.ts` - Model update
- `src/app/api/dreams/analyze/route.ts` - Model update
- `src/app/api/dreams/finalize/route.ts` - Model update
- `src/app/api/dreams/generate-suggestions/route.ts` - Model update

---

## Upgrade Notes

### From v3.1.1 to v3.2.0

**No action required** - All changes are backward compatible.

**Verify AI endpoints**:
```bash
# Test mission AI suggest
curl -X POST https://your-app.onrender.com/api/discover/mission/ai-suggest \
  -H "Content-Type: application/json" \
  -d '{"context": {...}}'

# Should return 200 with suggestions (not 404)
```

**Verify values session**:
```bash
# GET session status
curl https://your-app.onrender.com/api/discover/values/session

# Should return JSON with terminal_completed, instrumental_completed, work_completed
```

### Breaking Changes

None - fully backward compatible with v3.1.1

---

## Known Issues

- Cross-module AI context system partially implemented (planned for v3.3)
- Some modules (Life Themes, ERRC) may need SessionResetButton integration on landing pages

---

## Performance Notes

- Claude Sonnet 4 may have different latency characteristics than Claude 3.5 Sonnet
- No observed performance regressions in testing

---

**GitHub Release**: [v3.2.0](https://github.com/HosungYou/wfed119/releases/tag/v3.2.0)
