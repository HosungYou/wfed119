# Release v3.2.5 - Enneagram Assessment Overhaul & VS Design Diverge Result Page

**Release Date**: 2026-01-19
**Type**: Major Feature Release + Critical Bug Fix
**Commits**: `391a42f`, `d4c6e4b`
**Files Modified**: 11 files
**Status**: âœ… Production Ready

---

## ğŸ› Critical Bug Fixes

### 1. **Session Restoration Bug - AI Interpretation Not Loading**

**Error**: When returning to a completed Enneagram assessment, the detailed AI interpretation section was missing - only basic results (Type, Wing, Instinct) displayed.

**Root Cause**:
```typescript
// Before (problematic code) - src/app/discover/enneagram/page.tsx:215
if (stage === 'complete' && canFetch && !enneagramResult && !resultLoading) {
  fetchResultsAndInterpretation();
}
// When session restored, enneagramResult was already populated
// Condition !enneagramResult was FALSE â†’ fetchResultsAndInterpretation() never called
// Therefore interpretation state remained null
```

**Fix Mechanism**:
```typescript
// After (fixed code)
if (stage === 'complete' && canFetch && !resultLoading) {
  if (enneagramResult && !interpretation) {
    // Session restored: have result but missing interpretation
    fetchInterpretationOnly();
  } else if (!enneagramResult) {
    // Fresh completion: fetch both
    fetchResultsAndInterpretation();
  }
}

// New function added
async function fetchInterpretationOnly() {
  setInterpLoading(true);
  try {
    const res = await fetch(`/api/enneagram/interpret?sessionId=${sessionId}`);
    const data = await res.json();
    setInterpretation(data);
  } finally {
    setInterpLoading(false);
  }
}
```

**Impact**: Users returning to completed assessments now see full AI interpretation.

---

## ğŸš€ Major Features

### 1. **Enneagram Assessment Overhaul (Dr. Yoon Feedback)**

#### 1.1 Module Sequence Change
**File**: `src/lib/types/modules.ts`

**Change**: Temporarily disabled Strengths module

```typescript
// Before
export const MODULE_ORDER: ModuleId[] = [
  'values',
  'strengths',      // Active
  'enneagram',
  // ...
];

// After
export const MODULE_ORDER: ModuleId[] = [
  'values',
  // 'strengths',   // TEMPORARILY DISABLED per Dr. Yoon feedback
  'enneagram',
  // ...
];
```

**Dependencies Updated**: Enneagram module no longer requires Strengths completion.

#### 1.2 New 45-Item Screener (p.66-69)
**File**: `src/lib/enneagram/itemBank.ts`

**Change**: Replaced 36 items (4 Ã— 9 types) with 45 items (5 Ã— 9 types) from textbook

**Structure**:
| Type | ID Range | Sample Item (KO) |
|------|----------|------------------|
| 1 | s1_01-05 | "ë‚˜ëŠ” í•­ìƒ ë„ë•ì ì´ê³  ìœ¤ë¦¬ì ì¸ ê¸°ì¤€ì„ ì¶©ì¡±í•˜ë ¤ê³  ë…¸ë ¥í•œë‹¤." |
| 2 | s1_06-10 | "ë‚˜ëŠ” ë‹¤ë¥¸ ì‚¬ëŒì„ ë•ëŠ” ê²ƒì„ ì¦ê²¨í•œë‹¤." |
| 3 | s1_11-15 | "ë‚˜ëŠ” í•­ìƒ ëª©í‘œë¥¼ ì„¤ì •í•˜ê³  ê·¸ê²ƒì„ ë‹¬ì„±í•˜ë ¤ ë…¸ë ¥í•œë‹¤." |
| 4 | s1_16-20 | "ë‚˜ëŠ” ë‚´ê°€ íŠ¹ë³„í•˜ê³  ë…ì°½ì ì¸ ì¡´ì¬ë¼ê³  ëŠë¼ê³  ì‹¶ë‹¤." |
| 5 | s1_21-25 | "ë‚˜ëŠ” ìƒˆë¡œìš´ ì§€ì‹ì„ ë°°ìš°ê³  íƒêµ¬í•˜ëŠ” ê²ƒì„ ì¢‹ì•„í•œë‹¤." |
| 6 | s1_26-30 | "ë‚˜ëŠ” í•­ìƒ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” êµ¬ì¡°ì™€ ì•ˆì •ëœ í™˜ê²½ì„ ì°¾ëŠ”ë‹¤." |
| 7 | s1_31-35 | "ë‚˜ëŠ” í•­ìƒ ìƒˆë¡œìš´ ê²½í—˜ê³¼ í¥ë¯¸ë¡œìš´ ê¸°íšŒë¥¼ ì°¾ëŠ”ë‹¤." |
| 8 | s1_36-40 | "ë‚˜ëŠ” í˜ê³¼ ììœ¨ì„±ì„ ìœ ì§€í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•˜ë‹¤ê³  ìƒê°í•œë‹¤." |
| 9 | s1_41-45 | "ë‚˜ëŠ” í•­ìƒ ë‚´ì Â·ì™¸ì  í‰í™”ë¥¼ ìœ ì§€í•˜ë ¤ê³  ë…¸ë ¥í•œë‹¤." |

#### 1.3 Fisher-Yates Shuffle + Refresh Button
**Files**: `src/app/api/enneagram/items/route.ts`, `src/app/discover/enneagram/page.tsx`

**Shuffle Algorithm**:
```typescript
function shuffleArray<T>(array: T[]): T[] {
  const shuffled = [...array];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
}

// Applied in screener stage
if (stage === 'screener') {
  const items = getScreenerItems(locale);
  const shuffled = shuffleArray([...items]);
  return NextResponse.json({ items: shuffled });
}
```

**Refresh Button UI**:
```typescript
<button
  onClick={() => {
    setRefreshKey(k => k + 1);
    setScreenerResponses({});
  }}
  className="flex items-center gap-2 px-4 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded-xl"
>
  <RefreshCw className={`w-4 h-4 ${loading ? 'animate-spin' : ''}`} />
  {locale === 'kr' ? 'ìˆœì„œ ì„ê¸°' : 'Shuffle Items'}
</button>
```

#### 1.4 Narrative Prompt Update
**Change**: "in stress or ease" â†’ "under pressure or relaxed"

```typescript
// Before
'In stress or ease, how do your priorities and behavior shift?'

// After
'Under pressure or relaxed, how do your priorities and behavior shift? Give a brief example.'
```

#### 1.5 Instinct Subtype Labels
**File**: `src/lib/enneagram/instincts.ts`

**New Constant**:
```typescript
export const INSTINCT_DISPLAY_NAMES = {
  sp: { en: 'Self Preservation', ko: 'ìê¸°ë³´ì¡´' },
  so: { en: 'Social', ko: 'ì‚¬íšŒì ' },
  sx: { en: 'Intimate', ko: 'ì¹œë°€' },  // Changed from "Sexual"
};
```

---

### 2. **VS Design Diverge Result Page Redesign**

#### 2.1 New Component Architecture
**File**: `src/components/enneagram/EnneagramResultDisplay.tsx` (NEW, 583 lines)

**Design Aesthetic**: Editorial Magazine + Dark Mode + Data Visualization

#### 2.2 Type Center Color System
```typescript
const TYPE_CENTERS: Record<number, { center: string; color: string; gradient: string }> = {
  // Body Center (Types 8, 9, 1) - Red/Coral
  8: { center: 'Body', color: '#ef4444', gradient: 'from-red-500 to-rose-600' },
  9: { center: 'Body', color: '#f87171', gradient: 'from-rose-400 to-red-500' },
  1: { center: 'Body', color: '#fb7185', gradient: 'from-rose-500 to-pink-600' },

  // Heart Center (Types 2, 3, 4) - Amber/Gold
  2: { center: 'Heart', color: '#f59e0b', gradient: 'from-amber-400 to-orange-500' },
  3: { center: 'Heart', color: '#fbbf24', gradient: 'from-yellow-400 to-amber-500' },
  4: { center: 'Heart', color: '#d97706', gradient: 'from-orange-500 to-amber-600' },

  // Head Center (Types 5, 6, 7) - Indigo/Blue
  5: { center: 'Head', color: '#6366f1', gradient: 'from-indigo-500 to-blue-600' },
  6: { center: 'Head', color: '#818cf8', gradient: 'from-violet-500 to-indigo-600' },
  7: { center: 'Head', color: '#3b82f6', gradient: 'from-blue-500 to-cyan-600' },
};
```

#### 2.3 Visual Components

**Probability Distribution Chart**:
- Horizontal bar chart for all 9 types
- Type-specific gradient fills
- Primary type highlighted with ring indicator

**Integration/Disintegration Cards**:
- Growth direction (green) and stress direction (red)
- Arrow indicators showing type movement

**Core Fear/Desire Grid**:
- Side-by-side display with contrasting colors
- Red for fear, emerald for desire

**Healthy/Unhealthy Traits**:
- Tag-based display with hover effects
- Semantic color coding (green/red)

**Subtype Detail Section**:
- Instinct-specific descriptions
- Dominant instinct highlighting

#### 2.4 Typography System
**File**: `src/app/layout.tsx`

```typescript
import { Outfit, Inter, Space_Grotesk, JetBrains_Mono } from "next/font/google";

const spaceGrotesk = Space_Grotesk({
  subsets: ["latin"],
  variable: "--font-space-grotesk",
  display: "swap",
});

const jetbrainsMono = JetBrains_Mono({
  subsets: ["latin"],
  variable: "--font-jetbrains-mono",
  display: "swap",
});
```

**File**: `config/tailwind.config.js`

```javascript
fontFamily: {
  sans: ['var(--font-outfit)', 'var(--font-inter)', 'system-ui', 'sans-serif'],
  'space-grotesk': ['var(--font-space-grotesk)', 'system-ui', 'sans-serif'],
  mono: ['var(--font-jetbrains-mono)', 'Menlo', 'monospace'],
},
```

---

## ğŸ› ï¸ Technical Implementation Details

### Component Extraction

**Before**: Result display embedded in `page.tsx` (700+ lines)
**After**:
- `page.tsx` â†’ Assessment wizard only (simplified)
- `EnneagramResultDisplay.tsx` â†’ Result visualization (new, 583 lines)

### Props Interface
```typescript
interface EnneagramResultDisplayProps {
  result: EnneagramResult;
  interpretation: InterpretResponse | null;
  locale: 'en' | 'kr';
  sessionId: string;
  narrativeTexts: string[];
}
```

### Self-Contained Download
Download functionality moved into new component:
```typescript
async function downloadAsJPG() {
  const canvas = await html2canvas(containerRef.current, {
    scale: 2,
    backgroundColor: '#0f172a', // Dark theme background
    logging: false,
    useCORS: true,
  });
  // ...
}
```

---

## ğŸ“Š Data Structure Changes

### Module Dependencies Update
```typescript
// Before
enneagram: {
  dependencies: [
    { moduleId: 'values', required: true, ... },
    { moduleId: 'strengths', required: true, ... }  // Required
  ],
}

// After
enneagram: {
  dependencies: [
    { moduleId: 'values', required: true, ... }
    // strengths dependency removed
  ],
}
```

### New Instinct Display Names
```typescript
// Added to src/lib/enneagram/instincts.ts
export const INSTINCT_DISPLAY_NAMES = {
  sp: { en: 'Self Preservation', ko: 'ìê¸°ë³´ì¡´' },
  so: { en: 'Social', ko: 'ì‚¬íšŒì ' },
  sx: { en: 'Intimate', ko: 'ì¹œë°€' },
};
```

---

## ğŸ”§ Deployment Verification

### Build Success
```bash
npm run build
# âœ… Compiled successfully
# âœ… Generating static pages (36/36)
# âœ… Collecting page data
# âœ… Finalizing page optimization
```

### Dependencies
```bash
npm install mammoth --save  # Required for build
```

---

## ğŸ“‹ Technical Summary

**Files Modified**: 11 files

| File | Changes |
|------|---------|
| `src/lib/types/modules.ts` | Disable strengths module |
| `src/lib/enneagram/itemBank.ts` | 45 new screener items |
| `src/lib/enneagram/instincts.ts` | Add INSTINCT_DISPLAY_NAMES |
| `src/app/api/enneagram/items/route.ts` | Add shuffle, update prompts |
| `src/app/discover/enneagram/page.tsx` | Add refresh button, fix session restoration |
| `src/components/enneagram/EnneagramResultDisplay.tsx` | NEW - Result visualization |
| `src/app/layout.tsx` | Add Space Grotesk, JetBrains Mono fonts |
| `config/tailwind.config.js` | Add font family configuration |
| `docs/guides/2026-01-19_enneagram-algorithm-guide.md` | NEW - Algorithm documentation |
| `docs/README.md` | Add link to algorithm guide |

**Algorithmic Achievement**: Fisher-Yates O(n) shuffle + session restoration logic fix

**Next Release**: v3.2.6 - Narrative AI integration verification

---

## ğŸ“ Commits Included

### 391a42f - feat(enneagram): update assessment based on Dr. Yoon feedback
- Temporarily disable Strengths module
- Replace screener items with 45 questions (5 Ã— 9 types)
- Add Fisher-Yates shuffle for randomization
- Add "Shuffle Items" refresh button
- Update narrative prompt wording
- Update instinct subtype labels (Sexual â†’ Intimate)
- Add INSTINCT_DISPLAY_NAMES constant
- Create algorithm documentation guide

### d4c6e4b - feat(enneagram): redesign result page with VS Design Diverge
- Fix session restoration bug for AI interpretation
- New EnneagramResultDisplay component (583 lines)
- Type center color system (Body/Heart/Head)
- Horizontal bar charts for probability distribution
- Integration/disintegration direction visualization
- Core Fear/Desire grid display
- Healthy/unhealthy traits tags
- Subtype detail section
- Add Space Grotesk and JetBrains Mono fonts
- Dark mode theme for result display

---

## ğŸ”„ Upgrade Instructions

1. **Pull Latest Code**:
   ```bash
   git pull origin main
   ```

2. **Install Dependencies**:
   ```bash
   npm install
   ```

3. **Verify Build**:
   ```bash
   npm run build
   ```

4. **Test Enneagram Flow**:
   - Complete Values module
   - Verify Enneagram is next (not Strengths)
   - Complete 45-item screener
   - Test shuffle button functionality
   - Complete assessment and verify result page
   - Refresh page and verify AI interpretation loads

---

**Upgrade Priority**: ğŸ”´ **High** - Contains critical session restoration bug fix

**Breaking Changes**: Strengths module temporarily disabled

**Database Migration**: None required
