# Release v3.3.5 - Groq Migration + Life Themes AI Conversation Step

**Release Date**: 2026-02-02
**Type**: Major Feature Release + Architecture Change
**Commit**: `9331f76`
**Files Modified**: 26 files (23 modified, 3 new)
**Status**: âœ… Production Ready

**âš ï¸ BREAKING CHANGE**: Requires `GROQ_API_KEY` environment variable

---

## ðŸš€ Part 1: AI Service Migration (Anthropic â†’ Groq)

### Overview

Complete migration from Anthropic Claude SDK to Groq SDK across all 22 AI-powered endpoints.

**SDK Change**:
```bash
# Removed
npm uninstall @anthropic-ai/sdk

# Added
npm install groq-sdk
```

**Environment Variable Change**:
| Before | After |
|--------|-------|
| `ANTHROPIC_API_KEY` | `GROQ_API_KEY` |

**Model Change**:
| Before | After |
|--------|-------|
| `claude-sonnet-4-20250514` | `llama-3.3-70b-versatile` |
| `claude-3-haiku-20240307` | `llama-3.3-70b-versatile` |

---

### API Migration Pattern

**Before (Anthropic)**:
```typescript
import Anthropic from '@anthropic-ai/sdk';

const anthropic = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY });

const message = await anthropic.messages.create({
  model: 'claude-sonnet-4-20250514',
  max_tokens: 4096,
  messages: [{ role: 'user', content: prompt }],
});

const response = message.content[0].text;
```

**After (Groq)**:
```typescript
import Groq from 'groq-sdk';

const groq = new Groq({ apiKey: process.env.GROQ_API_KEY });

const completion = await groq.chat.completions.create({
  model: 'llama-3.3-70b-versatile',
  max_tokens: 4096,
  messages: [{ role: 'user', content: prompt }],
  response_format: { type: 'json_object' }, // For JSON responses
});

const response = completion.choices[0]?.message?.content;
```

---

### Files Migrated

#### Core Service
| File | Function |
|------|----------|
| `src/lib/services/aiServiceClaude.ts` | Core AI service with chat/streaming/goals |

#### Vision Module (SSE Streaming)
| File | Function |
|------|----------|
| `src/app/api/discover/vision/ai-chat/route.ts` | 3-step vision creation with SSE |
| `src/app/api/discover/vision/validate/route.ts` | Vision statement validation |

#### Mission Module
| File | Function |
|------|----------|
| `src/app/api/discover/mission/ai-suggest/route.ts` | Mission drafts |
| `src/app/api/discover/mission/ai-questions/route.ts` | Clarifying questions |
| `src/app/api/discover/mission/ai-roles/route.ts` | Role suggestions |
| `src/app/api/discover/mission/ai-commitments/route.ts` | Commitment statements |

#### Career Options Module
| File | Function |
|------|----------|
| `src/app/api/discover/career-options/ai-suggest/route.ts` | Career suggestions |
| `src/app/api/discover/career-options/analyze-resume/route.ts` | Resume parsing |

#### SWOT Module
| File | Function |
|------|----------|
| `src/app/api/swot/auto-fill/route.ts` | Auto-populate quadrants |
| `src/app/api/swot/generate-strategies/route.ts` | 16 SWOT strategies |
| `src/app/api/swot/generate-reflection-questions/route.ts` | Reflection questions |
| `src/app/api/swot/generate-reflection-draft/route.ts` | Draft essay |

#### Dreams Module
| File | Function |
|------|----------|
| `src/app/api/dreams/analyze/route.ts` | Dream analysis |
| `src/app/api/dreams/generate-suggestions/route.ts` | Dream suggestions |
| `src/app/api/dreams/finalize/route.ts` | Life narrative |

#### Enneagram Module
| File | Function |
|------|----------|
| `src/app/api/enneagram/interpret/route.ts` | Test interpretation |

#### Wrapper Routes
| File | Function |
|------|----------|
| `src/app/api/goals/ai/suggest/route.ts` | Goal suggestions |

---

## ðŸš€ Part 2: Life Themes AI Conversation Step

### New Flow

```
Before: Q1-Q6 â†’ Findings â†’ Follow-up â†’ Results
After:  Q1-Q6 â†’ AI Conversation (3-5 exchanges) â†’ Findings â†’ Follow-up â†’ Results
```

### Feature Implementation

#### 1. Database Schema

**File**: `database/migrations/2026-02-02-life-themes-conversation.sql`

```sql
CREATE TABLE IF NOT EXISTS life_themes_conversations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID NOT NULL REFERENCES life_themes_sessions(id) ON DELETE CASCADE,
  messages JSONB NOT NULL DEFAULT '[]',
  themes_suggested BOOLEAN DEFAULT false,
  themes_confirmed BOOLEAN DEFAULT false,
  suggested_themes JSONB,
  exchange_count INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLS Policies
CREATE POLICY "Users can view own conversations" ON life_themes_conversations
  FOR SELECT USING (session_id IN (
    SELECT id FROM life_themes_sessions WHERE user_id = auth.uid()
  ));
```

#### 2. TypeScript Types

**File**: `src/lib/types/lifeThemes.ts`

```typescript
// Added to LifeThemesStep
export type LifeThemesStep =
  | 'role_models' | 'media' | 'hobbies' | 'mottos' | 'subjects' | 'memories'
  | 'conversation'  // NEW STEP
  | 'findings' | 'followup' | 'results';

// New interfaces
export interface ConversationMessage {
  role: 'ai' | 'user';
  content: string;
  timestamp: string;
}

export interface SuggestedThemeData {
  name: string;
  description: string;
  evidence: string[];
  confidence: number;  // 0-100
}

export interface ConversationState {
  messages: ConversationMessage[];
  exchangeCount: number;
  themesSuggested: boolean;
  themesConfirmed: boolean;
  suggestedThemes?: SuggestedThemeData[];
}
```

#### 3. API Route

**File**: `src/app/api/life-themes/conversation/route.ts`

| Endpoint | Method | Function |
|----------|--------|----------|
| `/api/life-themes/conversation` | GET | Fetch conversation state |
| `/api/life-themes/conversation` | POST | Send message / confirm themes |

**Constants**:
```typescript
const MAX_EXCHANGES = 5;
const MIN_EXCHANGES_FOR_THEMES = 3;
```

**AI Prompt Structure**:
- Uses Career Construction Interview methodology (Mark Savickas)
- Personalizes questions based on user's Enneagram type (Light Touch)
- Auto-suggests themes after 3 exchanges with confidence scores

#### 4. Conversation UI Page

**File**: `src/app/discover/life-themes/conversation/page.tsx`

**Features**:
- Chat interface with message bubbles
- Progress indicator (Exchange 1/3, 2/3, 3/3)
- Theme suggestion cards with confidence scores
- "Confirm & Continue" / "Chat More" action buttons
- Suspense boundary for useSearchParams()

---

### Mandatory Field Validation

**File**: `src/app/discover/life-themes/questions/[question]/page.tsx`

```typescript
// Validation function for each question type
const validateData = useCallback((data: ResponseData | null): boolean => {
  if (!data) return false;

  switch (questionNum) {
    case 1: // Role Models
      const entries = data as RoleModelEntry[];
      return entries.length > 0 && entries.every(e =>
        e.name?.trim() && e.similarities?.trim() && e.differences?.trim()
      );
    // ... other cases
  }
}, [questionNum]);
```

**UI Changes**:
- Next button disabled when form is invalid (visual feedback)
- Warning message shown when fields are incomplete
- Q6 button text changed: "Continue to AI Conversation"

---

### Navigation Updates

**Q6 Navigation Change**:
```typescript
// Before
await updateStage('findings', 60);
router.push('/discover/life-themes/findings');

// After
await updateStage('conversation', 60);
router.push('/discover/life-themes/conversation');
```

**Findings Back Button**:
```typescript
// Before
router.push('/discover/life-themes/questions/6')

// After
router.push('/discover/life-themes/conversation')
```

---

## ðŸ“‹ Technical Summary

**Files Modified**: 26 files
- `package.json` - Replaced @anthropic-ai/sdk with groq-sdk
- `src/lib/services/aiServiceClaude.ts` - Core migration to Groq
- `src/lib/types/lifeThemes.ts` - Added conversation types
- 19 API routes - Migrated to Groq SDK
- `src/app/discover/life-themes/questions/[question]/page.tsx` - Mandatory validation + navigation
- `src/app/discover/life-themes/findings/page.tsx` - Back button navigation

**New Files Created**: 3 files
- `database/migrations/2026-02-02-life-themes-conversation.sql`
- `src/app/api/life-themes/conversation/route.ts`
- `src/app/discover/life-themes/conversation/page.tsx`

---

## ðŸ”§ Deployment Requirements

### Environment Variables

Add to Render (or your deployment platform):

```bash
GROQ_API_KEY=gsk_your_groq_api_key_here
```

### Database Migration

Run in Supabase SQL Editor:
```sql
-- Copy contents of database/migrations/2026-02-02-life-themes-conversation.sql
```

### Verification Steps

1. âœ… Build completes without errors
2. â¬œ Deploy to Render (auto-deploy from main)
3. â¬œ Run database migration in Supabase
4. â¬œ Test Life Themes flow: Q1-Q6 â†’ Conversation â†’ Findings

---

**Algorithmic Achievement**: Complete AI provider migration (22 endpoints) + new conversational theme discovery feature with hybrid auto-suggest mechanism

**Next Release**: v3.3.6 - Additional testing and polish for conversation feature
