# Release v3.3.7 - Fix checkDevAuth User Object Wrapping Bug

**Release Date**: 2026-02-17
**Type**: Critical Bug Fix
**Commit**: `0e960ce`
**Files Modified**: 5 files (7 occurrences)
**Status**: Production Ready

---

## Bug Report

Student reported: "After completing Terminal Values and Instrumental Values, the progress tab says 0/3 completed."

---

## Root Cause Analysis

### **checkDevAuth() called with wrapped user object**

**Error**: Values Discovery progress always shows 0/3 completed despite successful saves
**Root Cause**: 7 API route handlers passed `{ user }` (wrapped object) instead of `user` (direct object) to `checkDevAuth()`

**Fix Mechanism**:

```typescript
// Before (bug - user object wrapped in extra layer)
const { data: { user } } = await supabase.auth.getUser();
const auth = checkDevAuth(user ? { user } : null);
// Inside checkDevAuth: user?.id → { user: <SupabaseUser> }.id → undefined → userId = ""

// After (fix - user object passed directly)
const { data: { user } } = await supabase.auth.getUser();
const auth = checkDevAuth(user);
// Inside checkDevAuth: user?.id → <SupabaseUser>.id → "abc-123-..." (correct UUID)
```

**Impact Chain**:

```
checkDevAuth({ user })          ← wrapped object
  → user?.id = undefined        ← { user: {...} } has no .id
  → userId = ""                 ← fallback to empty string
  → .eq('user_id', "")          ← queries with empty string
  → no rows returned            ← no match in value_results
  → isCompleted = false          ← all sets appear incomplete
  → Progress: 0/3 completed     ← student sees this
```

**Data Integrity**: Student data was saved correctly the entire time (POST handlers used `user.id` directly). Only the GET/read handlers were affected.

---

## Affected Files

| File | Lines Fixed | Impact |
|------|-------------|--------|
| `src/app/api/discover/values/session/route.ts` | 16, 89 | Values progress 0/3 (reported bug) |
| `src/app/api/discover/vision/session/route.ts` | 31, 110 | Vision session read failure |
| `src/app/api/discover/vision/context/route.ts` | 67 | Vision cross-module context empty |
| `src/app/api/discover/vision/check-prerequisites/route.ts` | 18 | Vision prerequisites check failure |
| `src/app/api/discover/strengths/results/route.ts` | 45 | Strengths results read failure |

## Unaffected Files

70+ other API routes already used the correct `checkDevAuth(user)` pattern. Examples:
- `api/goals/session/route.ts`
- `api/errc/session/route.ts`
- `api/life-themes/session/route.ts`
- `api/discover/mission/session/route.ts`
- `api/swot/session/route.ts`

---

## Verification

```bash
# Confirm no remaining instances of the buggy pattern
grep -r "checkDevAuth(user ? { user }" src/
# Expected: No matches found ✅
```

---

## Technical Summary

**Files Modified**: 5 files
- `src/app/api/discover/values/session/route.ts` - Fixed GET and DELETE handlers
- `src/app/api/discover/vision/session/route.ts` - Fixed GET and POST handlers
- `src/app/api/discover/vision/context/route.ts` - Fixed GET handler
- `src/app/api/discover/vision/check-prerequisites/route.ts` - Fixed GET handler
- `src/app/api/discover/strengths/results/route.ts` - Fixed GET handler

**Fix Pattern**: `checkDevAuth(user ? { user } : null)` → `checkDevAuth(user)` (all 7 occurrences)

**Next Release**: v3.4.0 - TBD
