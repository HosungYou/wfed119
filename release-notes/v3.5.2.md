# Release v3.5.2 - Auth & Dashboard Access Fix

**Release Date**: 2026-02-18
**Type**: Bug Fix (Critical)
**Commit**: `e9f9087`
**Files Modified**: 3 files
**Net Change**: +35 / -8 lines
**Status**: Production Deployed (Render)

---

## Overview

Fixed a critical bug where authenticated users were unable to access `/dashboard` — clicking the Dashboard button triggered an infinite redirect loop back to `/?redirect=/dashboard&auth=required`. The root cause was a three-part failure in the Supabase SSR authentication flow between OAuth, the auth callback, and the Next.js middleware.

---

## Bug Reports Fixed

### Bug 1 — `signInWithOAuth` missing `redirectTo` (Root Cause)

**File:** `src/contexts/AuthContext.tsx`

**Symptom:** After Google login, the client-side auth state showed `SIGNED_IN` but the server-side middleware kept returning "unauthenticated", redirecting users away from all protected routes (`/dashboard`, `/discover`, etc.).

**Root Cause:**

`createBrowserClient` from `@supabase/ssr` uses **PKCE flow** by default. PKCE requires the OAuth authorization code to be exchanged server-side via the app's `/auth/callback` route by calling `exchangeCodeForSession()`. Without an explicit `redirectTo`, the OAuth callback never hit `/auth/callback`, so `exchangeCodeForSession()` was never called and **no SSR-compatible session cookies were set**.

The Supabase JS client detected the session client-side (via URL fragment or implicit fallback), causing `onAuthStateChange` to fire `SIGNED_IN` multiple times — but the middleware's `supabase.auth.getUser()` and `getSession()` calls found no cookies and returned `null`, triggering the redirect loop.

**Fix:**

```typescript
// Before — no redirectTo
const { error } = await supabase.auth.signInWithOAuth({
  provider: 'google',
  options: {
    queryParams: { access_type: 'offline', prompt: 'consent' },
  },
});

// After — explicit redirectTo including post-login destination
const next = new URLSearchParams(window.location.search).get('redirect') || '/dashboard';
const callbackUrl = `${window.location.origin}/auth/callback?next=${encodeURIComponent(next)}`;

const { error } = await supabase.auth.signInWithOAuth({
  provider: 'google',
  options: {
    redirectTo: callbackUrl,
    queryParams: { access_type: 'offline', prompt: 'consent' },
  },
});
```

---

### Bug 2 — Auth callback cookies not written to redirect response

**File:** `src/app/auth/callback/route.ts`

**Symptom:** Even when `/auth/callback` was reached, the session cookies were sometimes not propagated to subsequent requests, causing the middleware to fail authentication on the very next navigation.

**Root Cause:**

`exchangeCodeForSession()` internally calls the `setAll` cookie handler, which was writing cookies only to `cookieStore` (Next.js internal cookie store). When building the final `NextResponse.redirect()` *after* the cookie writes, those cookies were not guaranteed to appear in the HTTP response headers because the `NextResponse` object was created independently.

**Fix:**

Build the `NextResponse.redirect()` object *before* `exchangeCodeForSession()`, then write cookies to **both** `cookieStore` and the `response` object:

```typescript
// Before — cookies only set on cookieStore; redirect built after
const response = NextResponse.redirect(new URL('/', requestUrl.origin)); // created AFTER setAll
setAll(cookiesToSet) {
  cookiesToSet.forEach(({ name, value, options }) =>
    cookieStore.set(name, value, options)  // only cookieStore
  );
}

// After — response built first; cookies set on both
const response = NextResponse.redirect(redirectUrl); // created BEFORE setAll
setAll(cookiesToSet) {
  cookiesToSet.forEach(({ name, value, options }) => {
    cookieStore.set(name, value, options);
    response.cookies.set(name, value, options); // also on response headers
  });
}
return response; // carries auth cookies in Set-Cookie headers
```

Additionally, the callback now reads a `next` query parameter to redirect users to their intended destination instead of always redirecting to `/`:

```typescript
const next = requestUrl.searchParams.get('next') || '/dashboard';
const response = NextResponse.redirect(new URL(next, requestUrl.origin));
```

---

### Bug 3 — `HomePage` ignored `?redirect=` query parameter (Fallback Fix)

**File:** `src/components/HomePage.tsx`

**Symptom:** Users already authenticated (client-side session present) who landed on `/?redirect=/dashboard&auth=required` were not automatically navigated to `/dashboard` — the `redirect` URL param was silently discarded.

**Root Cause:**

The middleware correctly embeds the intended destination in `?redirect=` when bouncing unauthenticated users to `/`. However, `HomePage.tsx` never read this parameter. A comment in `auth/callback/route.ts` referenced this behavior ("HomePage will check sessionStorage") but the implementation was never added.

**Fix:**

```typescript
// Added to HomePage component
const router = useRouter();
const searchParams = useSearchParams();

useEffect(() => {
  if (!loading && isAuthenticated) {
    const redirect = searchParams.get('redirect');
    if (redirect && redirect.startsWith('/')) {
      router.replace(redirect);
    }
  }
}, [loading, isAuthenticated, searchParams, router]);
```

This acts as a safety net for users whose sessions are valid client-side but were caught by the middleware before cookies were refreshed.

---

## Authentication Flow (After Fix)

```
User clicks "Sign in with Google"
  └─► signInWithOAuth({ redirectTo: '/auth/callback?next=/dashboard' })
        └─► Google OAuth
              └─► /auth/callback?code=xxx&next=/dashboard
                    └─► exchangeCodeForSession(code)        ← sets cookies on response
                          └─► redirect to /dashboard        ← with Set-Cookie headers
                                └─► middleware: getUser() ✓
                                      └─► /dashboard loads
```

---

## Files Modified (3)

| File | Change |
|------|--------|
| `src/contexts/AuthContext.tsx` | Add `redirectTo` with `next` param to `signInWithOAuth` |
| `src/app/auth/callback/route.ts` | Set cookies on response object; handle `next` redirect param |
| `src/components/HomePage.tsx` | Add `useEffect` to redirect when `?redirect=` param present |

---

## Verification

- Clicking Dashboard while logged in → navigates to `/dashboard` directly
- Fresh Google login → redirects to `/dashboard` (not `/`)
- Middleware `getUser()` / `getSession()` returns valid session
- No redirect loop on protected routes

---

## Commit History

```
e9f9087 fix: dashboard inaccessible after login due to missing OAuth redirectTo
```

---

## Previous Release

[v3.5.1](./v3.5.1.md) — TDD Tests & Vercel Deployment
