# Release v3.5.3 - Fix OAuth Redirect to localhost on Render.com

**Release Date**: 2026-02-18
**Type**: Bug Fix (Critical)
**Commit**: `22e7450`
**Files Modified**: 1 file
**Net Change**: +12 / -2 lines
**Status**: Production Deployed (Render)

---

## Overview

Fixed a critical bug where logging in via Google OAuth caused the browser to be redirected to `http://localhost:10000/dashboard`, resulting in **ERR_CONNECTION_REFUSED**. The issue was caused by Render.com's reverse proxy architecture overwriting `request.url` with an internal host, which was then used verbatim to build the post-login redirect URL.

---

## Bug Fixed — Auth Callback Redirects to `localhost:10000`

**File:** `src/app/auth/callback/route.ts`

### Symptom

After clicking "Sign in with Google" on the production deployment, the browser was redirected to:

```
http://localhost:10000/dashboard
ERR_CONNECTION_REFUSED
```

### Root Cause

Render.com runs the Next.js server on **port 10000** internally and fronts it with a reverse proxy that terminates HTTPS externally. When Google OAuth redirects back to the app (e.g., `https://wfed119.onrender.com/auth/callback?code=...`), Render's proxy rewrites the request internally to `http://localhost:10000/auth/callback?code=...` before forwarding it to Next.js.

In the auth callback route handler, the origin was derived directly from `request.url`:

```typescript
// Before — uses internal Render URL as origin
const requestUrl = new URL(request.url)
// requestUrl.origin = "http://localhost:10000"  ← internal Render address

const redirectUrl = new URL(next, requestUrl.origin)
// redirectUrl = "http://localhost:10000/dashboard"  ← sent to browser!
```

The browser then tried to reach `http://localhost:10000/dashboard` — a port only accessible inside Render's infrastructure — and failed.

### Fix

Read the `x-forwarded-host` and `x-forwarded-proto` headers that Render's reverse proxy sets on every forwarded request. These contain the actual public hostname and protocol. Fall back to `requestUrl.origin` for local development (where these headers are absent).

```typescript
// After — reconstruct public origin from proxy headers
const forwardedHost = request.headers.get('x-forwarded-host')
const forwardedProto = request.headers.get('x-forwarded-proto') ?? 'https'
const origin = forwardedHost
  ? `${forwardedProto}://${forwardedHost}`
  : requestUrl.origin
// origin = "https://wfed119.onrender.com"  ← correct public URL

const redirectUrl = new URL(next, origin)
// redirectUrl = "https://wfed119.onrender.com/dashboard"  ✓
```

Applied to both the success redirect and the fallback error redirect.

---

## Authentication Flow (After Fix)

```
User clicks "Sign in with Google"
  └─► signInWithOAuth({ redirectTo: 'https://wfed119.onrender.com/auth/callback?next=/dashboard' })
        └─► Google OAuth
              └─► Render proxy receives: https://wfed119.onrender.com/auth/callback?code=xxx
                    └─► Forwarded internally as: http://localhost:10000/auth/callback?code=xxx
                          └─► Route handler reads x-forwarded-host: wfed119.onrender.com
                                └─► origin = "https://wfed119.onrender.com"  ✓
                                      └─► exchangeCodeForSession(code)
                                            └─► redirect to https://wfed119.onrender.com/dashboard  ✓
```

---

## Files Modified (1)

| File | Change |
|------|--------|
| `src/app/auth/callback/route.ts` | Use `x-forwarded-host`/`x-forwarded-proto` headers to build correct public origin |

---

## Verification

- Google OAuth login → redirects to `https://wfed119.onrender.com/dashboard` ✓
- No `localhost:10000` in redirect URLs ✓
- Local development unaffected (falls back to `requestUrl.origin`) ✓
- Fallback error redirect also uses correct origin ✓

---

## Commit History

```
22e7450 fix: resolve localhost:10000 redirect on Render.com after OAuth login
```

---

## Previous Release

[v3.5.2](./v3.5.2.md) — Auth & Dashboard Access Fix
